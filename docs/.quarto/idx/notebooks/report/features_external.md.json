{"title":"External Data","markdown":{"headingText":"External Data","containsRefs":false,"markdown":"\nThe complete implementation for integrating external data can be found in our [source code](https://github.com/adabwana/sp25-m7560-final-project/blob/master/src/r/utils/create_data/external_data.R).\n\nBeyond the features derived directly from the Learning Commons dataset, we incorporated external data sources to potentially capture broader environmental influences on student behavior.\n\n## Data Handling\n\nBefore adding external features, the script first combines the `train_engineered.csv` and `test_engineered.csv` files (output from the primary feature engineering script). An `origin` column is added to track which dataset each row came from. This allows external data fetching (like weather) to be done efficiently across the entire date range. After adding external features, the combined dataset is split back into `train` and `test` sets based on the `origin` column before saving the final outputs.\n\n## Moon Phase Features\n\nWe (Jaryt) hypothesized (wanted to Jason to cringe) that lunar cycles might subtly influence activity patterns. To explore this, we used the R `lunar` package to calculate the moon phase for each `Check_In_Date`.\n\n```r\n# Relevant snippet from src/r/utils/create_data/external_data.R\nlibrary(lunar)\n\ndata_full <- data_full %>%\n  mutate(\n    Moon_Phase_Radians = lunar::lunar.phase(Check_In_Date, name = FALSE), # Get numeric phase in radians\n    Cosine_Phase = cos(Moon_Phase_Radians)\n    # Original code also calculated 8 discrete phases, but only Cosine_Phase was kept\n  ) %>%\n  select(-Moon_Phase_Radians) # Remove the intermediate radians column\n```\n\nThe `lunar.phase` function returns the phase as a value in radians. We then calculated the cosine of this value (`Cosine_Phase`). Using the cosine transforms the cyclical phase information into a continuous variable ranging from -1 to 1, which can be more easily incorporated into regression models than categorical phase names.\n\n## Weather Features\n\nLocal weather conditions could plausibly affect whether students choose to visit the Learning Commons or how long they stay. We used the `openmeteo` R package to fetch historical hourly weather data for Bowling Green, Ohio.\n\n1.  **Define Parameters**: We identified the date range from our combined dataset and specified the geographic coordinates for Bowling Green.\n\n    ```r\n    # Relevant snippet from src/r/utils/create_data/external_data.R\n    start_date <- min(data_full$Check_In_Date)\n    end_date <- max(data_full$Check_In_Date)\n\n    bowling_green_coords <- c(\n      latitude = 41.374775,\n      longitude = -83.651321\n    )\n    ```\n\n2.  **Fetch Data**: We requested various hourly metrics (including temperature, cloud cover, wind speed, precipitation, rain, snowfall, etc.) using the `weather_history` function. Error handling was included in case the API request failed.\n\n    ```r\n    library(openmeteo)\n    \n    response_units <- list(\n      temperature_unit = \"fahrenheit\",\n      windspeed_unit = \"kmh\",\n      precipitation_unit = \"mm\"\n    )\n    \n    all_hourly_vars <- weather_variables()[[\"hourly_history_vars\"]]\n    \n    weather_history <- tryCatch({\n        weather_history(\n          location = bowling_green_coords,\n          start = start_date,\n          end = end_date,\n          response_units = response_units,\n          hourly = all_hourly_vars\n        )\n    }, error = function(e) {\n        warning(glue(\"Failed to fetch weather data: {e$message}\\nProceeding without weather features.\"), call. = FALSE)\n        NULL # Return NULL if fetching fails\n    })\n    ```\n\n3.  **Prepare and Merge**: If the weather data was fetched successfully, we prepared it for joining. This involved selecting relevant columns, renaming them with a `weather_` prefix, and creating a common `Hourly_Timestamp_Floor` key in both the weather data and our main dataset (by flooring the `Check_In_Datetime` to the beginning of the hour as preventing future weather from influencing a student's decision to come or go to the LC). A `left_join` merged the corresponding hourly weather data onto each visit record.\n\n    ```r\n    # Relevant snippet from src/r/utils/create_data/external_data.R\n    if (!is.null(weather_history)) {\n        weather_to_join <- weather_history %>%\n          select(datetime, starts_with(\"hourly_\")) %>%\n          rename_with(~ paste0(\"weather_\", .), starts_with(\"hourly_\")) %>%\n          rename(Hourly_Timestamp_Floor = datetime)\n          \n        data_full <- data_full %>%\n          mutate(\n            Check_In_Datetime = ymd_hms(paste(Check_In_Date, Check_In_Time), quiet = TRUE),\n            Hourly_Timestamp_Floor = floor_date(Check_In_Datetime, \"hour\")\n          )\n          \n        data_full_ext <- left_join(data_full, weather_to_join, by = \"Hourly_Timestamp_Floor\")\n        \n        data_full_ext <- data_full_ext %>%\n          select(-Check_In_Datetime, -Hourly_Timestamp_Floor)\n    } else {\n        # Handle case where weather fetch failed\n        data_full_ext <- data_full\n    }\n    ```\n\n## Final Output\n\nAfter potentially adding the moon phase and weather features, the combined dataset was split back into training and testing sets based on the original `origin` flag and saved as `train_engineered.csv` and `test_engineered.csv` in the `data/processed` directory, overwriting the intermediate files generated by `feature_engineering.R`.","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":3,"number-sections":false,"output-file":"features_external.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.43","theme":"united"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html","revealjs"]}